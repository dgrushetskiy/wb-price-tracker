# REST API Application for tracking prices on Wildberries marketplace

### General options:
* **Users use the app to get information about the items and price updates they have added for tracking.**
  They can also edit their tracking list by adding or removing an item.
* **Prices are updated by the parser**, which, according to the schedule, requests the list of codes from the app,
  receives new data from Wildberries and sends it back to the app **using RabbitMq**. The updated data is sent to the Direct
  exchange binding by routing key with the queue the app is listening.
* **Data update schedule and asynchronous task executor** are configured in parser properties. <br/>
  * Schedule: initialDelay (delay before the first invocation to wait for the apps to start) = 30 sec; <br/>
  fixedRate (period between invocations) = 1 hour. <br/>
  * ThreadPoolExecutor: corePoolSize = 5; maxPoolSize = 10; queueCapacity = 50. <br/>
* Access to resources using a **JWT token in Authentication HTTP header** received when logging in to the profile.
* **Logging** using **log4j2** to console output and file.
* Database migration with **Liquibase**.
* **Validation** of input data.
* **Tests** : JUnit, Integration using Testcontainers
* Access Rest API endpoints by using **Swagger UI**
* Build and run app with **Docker Compose**

## Docker Compose ##
Start the docker containers from project directory using the following command :
```
docker-compose up -d
```
5 containers must be started:
* **api**
  * port : `8085`
* **parser**
  * port : `8086`
* **rabbitmq**
  * **RabbitMQ Management** is available at the link **http://localhost:15672/**
  * **Username** : admin
  * **Password** : admin
* **postgres**
  * **/db/changelog** directory has the necessary **changesets** for the database schema
  * data generated by the postgres container **will be persisted in volume**, 
  so it will be used next time the container is up
  * access to postgres : `localhost:5432`
  * **User** : postgres
  * **Password** : postgres
  * **Database** : wb-price-tracker-db
* **pgadmin**
  * **pgAdmin4** is available at the link **http://localhost:5050/**
  * **Password** : postgres
  * **Server postgres@docker** will be added to connect to the database, use postgres password to connect the server

Once the containers are running successfully, you will be able to access Rest API by using **Swagger UI** at the link :
* **http://localhost:8085/swagger-ui.html**

To test ***[API endpoints](#endpoints)*** the database will be initialized with the ***[next data](#database-initialization)***.

**Log4j2 .log files** inside the containers will be mapping to folder **./logs** in project directory, 
that will be created at apps running

To get .log files inside the container : 
* go inside the container : 
  * for **api** : `docker exec -it api sh`; for **parser** : `docker exec -it parser sh`;
* navigate to the folder /logs : `cd logs`
* view the list of files : `ls`
* view file content : `cat {log-file-name}.log`

## Endpoints
### Registration & Login
* Register new user with role "ROLE_USER" by default <br/>
```
POST /register
```
```
{
  "name":"TestUser1",
  "username":"TestUser1",
  "email":"testUser1@gmail.com",
  "password":"password"
}
```
* **Login user profile** <br/>
  In response you will get **JWT token in Authentication HTTP header** with "Bearer " prefix
```
POST /login
```
```
{
  "username":"TestUser1",
  "password":"password"
}
```
### User Options
* **Get list of user items** <br/>
  * You must send JWT token in "Authentication" HTTP header with "Bearer " prefix
  * If you try to get another user's list you will get response with HttpStatus 403 FORBIDDEN
```
GET /api/v1/users/{userId}/items
```
In response you will get JSON like:
```
{
  "username":"TestUser1",
  "items": [
    {
      "code":item code,
      "brand":"Brand Name",
      "name":"Item Name",
      "price":last checked price
    }
  ]
}
```
* **Add item code for price tracking to user profile** <br/>
  * You must send JWT token in "Authentication" HTTP header with "Bearer " prefix
  * If you try to add code to another user's profile you will get response with HttpStatus 403 FORBIDDEN
```
POST /api/v1/users/{userId}/items
```
```
{
  "code":item code
}
```
* **Get tracking info about current item prices** <br/>
  * It is possible to get price values for the entire tracking period
  * Or specify a time period in the parameters : **fromDate \ toDate** in format "yyyy-MM-dd"
  * You must send JWT token in "Authentication" HTTP header with "Bearer " prefix
  * If you try to get access to another user's profile you will get response with HttpStatus 403 FORBIDDEN
```
GET /api/v1/users/{userId}/items/{itemCode}?fromDate=yyyy-MM-dd&toDate=yyyy-MM-dd
```
In response you will get JSON like:
```
{
  "code":item code,
  "prices": [
    {
      "price":price,
      "date":"yyyy-MM-dd HH:mm:ss",
    }
  ]
}
```
* **Delete item code from user profile** <br/>
  * You must send JWT token in "Authentication" HTTP header with "Bearer " prefix
  * If you try to delete code from another user's profile you will get response with HttpStatus 403 FORBIDDEN
```
DELETE /api/v1/users/{userId}/items/{itemCode}
```
### Admin Options
Admin profile added by default when running the application

> Admin(1, 'AdminProfile', 'AdminProfile', 'admin@gmail.com','adminPassword', 'ROLE_ADMIN');

Profile with role "ROLE_ADMIN" has access to all user options
and in addition can get data about all users or a certain one <br/>
Admin options are not accessible for profiles with role "ROLE_USER"
* **Get data about all users** <br/>
  In response you will get JSON with list of all users with info : userId, name, username, email, list of tracking items
```
GET /api/v1/admin/users
```
* **Get data about user with id = {userId}** <br/>
  In response you will get JSON with info about certain user with : userId, name, username, email, list of tracking items
```
GET /api/v1/admin/users/{userId}
```
### Database initialization
The database will be initialized with the next data at the app running to test API endpoints : </br>
* **Users**

| id  |     name     |   username   |      email      |   password    |    role    |
|:---:|:------------:|:------------:|:---------------:|:-------------:|:----------:|
|  1  | AdminProfile | AdminProfile | admin@gmail.com | adminPassword | ROLE_ADMIN |
|  2  |    User1     |    User1     | user1@gmail.com |   password1   | ROLE_USER  |
|  3  |    User2     |    User2     | user2@gmail.com |   password2   | ROLE_USER  |
|  4  |    User3     |    User3     | user3@gmail.com |   password3   | ROLE_USER  |
|  5  |    User4     |    User4     | user4@gmail.com |   password4   | ROLE_USER  |

* **Items**

| id  |   code   |      brand      |        name        |
|:---:|:--------:|:---------------:|:------------------:|
|  1  | 15061503 |      Ticle      |      Футболка      |
|  2  | 32956137 |    UZcotton     |    Лонгслив бег    |
|  3  | 70455609 |    the nana     |       Брюки        |
|  4  | 37955601 |     MOANNA      |        Юбка        |
|  5  | 19364027 |  TRENDY TRUTH   | Рубашка удлиненная |
|  6  | 62880505 |    CALZETTI     |       Сумка        |
|  7  | 39404188 |      Ticle      |        Худи        |
|  8  | 37110732 |     Paetki      |       Платье       |
|  9  | 8118885  | Riccardo Donati |       Ремень       |
| 10  | 14566666 |    Ravenclo     |        Худи        |

* **Users_Items**

| User  |               Item codes               |
|:-----:|:--------------------------------------:|
| User1 | 15061503, 32956137, 70455609, 37955601 |
| User2 | 15061503, 19364027, 62880505, 39404188 |
| User3 | 39404188, 37110732, 8118885, 14566666  |
| User4 | 15061503, 37955601, 39404188, 14566666 |

* **Prices** </br>
For each item there are 4 price values with update time:
  * 2022-07-27 12:00:00
  * 2022-07-28 12:00:00
  * 2022-07-29 12:00:00
  * 2022-07-30 12:00:00

